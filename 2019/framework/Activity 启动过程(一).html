<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title># Activity 启动过程(一)</title>
<style>
@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

body {
  background-color: white;
}

.markdown-body {
  min-width: 200px;
  max-width: 760px;
  margin: 0 auto;
  padding: 20px;

  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;;word-wrap: break-word; word-break: break-all;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  height: 1em;
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}
table td{ word-wrap: break-word !important; word-break: break-all !important; }
/*

github.com style (c) Vasily Polovnyov <vast@whiteants.net>

*/

.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  color: #333;
  background: #f8f8f8;
  -webkit-text-size-adjust: none;
}

.hljs-comment,
.diff .hljs-header {
  color: #998;
  font-style: italic;
}

.hljs-keyword,
.css .rule .hljs-keyword,
.hljs-winutils,
.nginx .hljs-title,
.hljs-subst,
.hljs-request,
.hljs-status {
  color: #333;
  font-weight: bold;
}

.hljs-number,
.hljs-hexcolor,
.ruby .hljs-constant {
  color: #008080;
}

.hljs-string,
.hljs-tag .hljs-value,
.hljs-doctag,
.tex .hljs-formula {
  color: #d14;
}

.hljs-title,
.hljs-id,
.scss .hljs-preprocessor {
  color: #900;
  font-weight: bold;
}

.hljs-list .hljs-keyword,
.hljs-subst {
  font-weight: normal;
}

.hljs-class .hljs-title,
.hljs-type,
.vhdl .hljs-literal,
.tex .hljs-command {
  color: #458;
  font-weight: bold;
}

.hljs-tag,
.hljs-tag .hljs-title,
.hljs-rule .hljs-property,
.django .hljs-tag .hljs-keyword {
  color: #000080;
  font-weight: normal;
}

.hljs-attribute,
.hljs-variable,
.lisp .hljs-body,
.hljs-name {
  color: #008080;
}

.hljs-regexp {
  color: #009926;
}

.hljs-symbol,
.ruby .hljs-symbol .hljs-string,
.lisp .hljs-keyword,
.clojure .hljs-keyword,
.scheme .hljs-keyword,
.tex .hljs-special,
.hljs-prompt {
  color: #990073;
}

.hljs-built_in {
  color: #0086b3;
}

.hljs-preprocessor,
.hljs-pragma,
.hljs-pi,
.hljs-doctype,
.hljs-shebang,
.hljs-cdata {
  color: #999;
  font-weight: bold;
}

.hljs-deletion {
  background: #fdd;
}

.hljs-addition {
  background: #dfd;
}

.diff .hljs-change {
  background: #0086b3;
}

.hljs-chunk {
  color: #aaa;
}


</style>

<style> @media print{ .hljs{overflow: visible; word-wrap: break-word !important;} }</style></head><body><div class="markdown-body">
<h1 id="toc_0">Activity 启动过程(一)</h1>

<p>这里讲的是一个Activity启动另一个Activity的过程。<br/>
首先我们在activity.startActivity(),点进去我们可以看到如下</p>

<p><img src="media/15486766374750/15486772761818.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486772908727.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486773071393.jpg" alt=""/>￼</p>

<p>在Activity中最终都是调用startActivityForResult(),在这个方法中又调用mInstrumentation.execStartActivity()。</p>

<p><img src="media/15486766374750/15486776690721.jpg" alt=""/>￼</p>

<p>在这个方法里，调用了ActivityManager.getService().startActivity(),我们先来看看getService()会返回什么对象。</p>

<p><img src="media/15486766374750/15486778672837.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486778856899.jpg" alt=""/>￼</p>

<p>getService() 只是调用了IActivityManagerSingleton.get()。而IActivityManagerSingleton则是一个Singleton的实例。<br/>
Singleton的代码如下：<br/>
<img src="media/15486766374750/15486779802660.jpg" alt=""/>￼</p>

<p>从Singleton可以看到，IActivityManagerSingleton.get()在第一次的时候会调用create()，而这个IActivityManagerSingleton 的create() 正是的前面看到的这个方法：<br/>
<img src="media/15486766374750/15486778856899.jpg" alt=""/>￼</p>

<p>这里将通过IActivityManager.Stub.asInterface(b)返回一个IActivityManager对象实例。因此IActivityManagerSingleton.get()也将返回一个IActivityManager对象实例。</p>

<p>因为笔者这里看的是26的源码，26中增加了IActivityManager.aidl文件，这部分代码需要在<a href="http://androidxref.com/8.0.0_r4/xref/frameworks/base/core/java/android/app/IActivityManager.aidl">AndroidXref中的IActivityManager.aidl</a>中查看，部分定义如下：<br/>
<img src="media/15486766374750/15486787413207.jpg" alt=""/>￼</p>

<p>我们在使用aidl的时候，AS都会帮我们生成一个Stub和本地的代理对象。IActivityManager也会对应生成一个IActivityManager.Stub类，且它有个子类为ActivityManagerService <br/>
<img src="media/15486766374750/15486794120831.jpg" alt=""/>￼</p>

<p>而我们之前IActivityManagerSingleton.get()取得的就是一个ActivityManagerService或者是ActivityManagerService的一个代理。</p>

<blockquote>
<p>注：这一部分具体参考下Binder的定义及使用。另外我还没有说明如何能找到ActivityManagerService，这一部分都是参考其他文章所得，具体如何通过IActivityManager.aidl定位到这个类的，还需要再捋一捋。</p>
</blockquote>

<p>现在我们回到Instrumentation<br/>
<img src="media/15486766374750/15486797142078.jpg" alt=""/>￼</p>

<p>ActivityManager.getService() 即返回一个ActivityManagerService或者其代理对象。所以这里最终就是调用了ActivityManagerService.startActivity()<br/>
<br/><br/>
<strong>小结一：</strong><br/>
这里使用简单的时序图来说明方法的调用过程。这里的AMS即时ActivityManagerService的缩写，之后读将采用这个缩写来代码ActivityManagerService.</p>

<p><img src="media/15486766374750/15486811350826.jpg" alt=""/>￼</p>

<p><br/><br/>
<br/><br/>
我们通过前面方法的查找，已经知道启动一个Activity之后，最终会调用系统的ActivityManagerService.startActivity(),接下来我们就看看这个方法又做了哪些操作。</p>

<p><img src="media/15486766374750/15486816418828.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486816757171.jpg" alt=""/>￼</p>

<p>这里最后调用了mActivityStarter.startActivityMayWait(),这样就将调用过程转交给了ActivityStarter类。</p>

<p>在这个方法中可以看到下面这一句话，这主要是在收集目标Activity的信息，将信息存储在ActivityInfo中。<br/>
<img src="media/15486766374750/15486819210213.jpg" alt=""/>￼</p>

<p>之后又调用了本类中的startActivityLocked()，如下：<br/>
<img src="media/15486766374750/15486819855403.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486820892862.jpg" alt=""/>￼</p>

<p>在这里校验了调用方法的原因。然后调用了ActivityStarter中的startActivity()。<br/>
<img src="media/15486766374750/15486822330110.jpg" alt=""/>￼</p>

<p>在这个方法中主要做了一些校验，包括：权限校验、component校验、目标activity信息校验等。同时创建一个ActivityRecord对象，用来存放这些校验过后的数据：<br/>
<img src="media/15486766374750/15486827320180.jpg" alt=""/>￼</p>

<p>然后继续调用下一个startActivity()<br/>
<img src="media/15486766374750/15486827457382.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15486827875618.jpg" alt=""/>￼</p>

<p>在这个startActivity()中将调用ActivityStarter的startActivityUnchecked()，startActivityUnchecked()方法挺长，主要是activity栈的处理，比如是否在栈顶、是否需要新建一个栈。在这个方法中将调用mSupervisor.resumeFocusedStackTopActivityLocked().</p>

<p>这是怎么回事呢？<br/>
首先我们回到这里<br/>
<img src="media/15486766374750/15486827457382.jpg" alt=""/>￼</p>

<p>我们可以看到第六个参数设置为true，而这个true将一直跟着我们的方法传递下去，直到startActivityUnchecked调用了setInitialState()之后将这个true赋给了ActivityStarter中的mDoResume属性。</p>

<p><img src="media/15486766374750/15486841490088.jpg" alt=""/>￼<br/>
因此，最后我们将走入这个代码块。<br/>
这里两段英文，尝试着翻译一下：</p>

<blockquote>
<p>If the activity is not focusable, we can&#39;t resume it, but still would like to make sure it becomes visible as it starts (this will also trigger entry animation). An example of this are PIP activities.Also, we don&#39;t want to resume activities in a task that currently has an overlay as the starting activity just needs to be in the visible paused state until the over is removed.<br/>
如果Activity不可聚焦，就不能重启它，不过我们仍可保证当它启动的时候是可见的。比如PIP的活动。我们不想重启一个可覆盖任务中的activities，因为开始的活动只需要处于可见的暂停状态，直到移除覆盖。</p>

<p>If the target stack was not previously focusable (previous top running activity on that stack was not visible) then any prior calls to move the stack to the will not update the focused stack.  If starting the new activity now allows the task stack to be focusable, then ensure that we now update the focused stack accordingly.<br/>
如果目标栈之前不可获取焦点（之前顶层的activity不可见），那么将该栈移动到不会更新的焦点栈中。如果现在是新建一个activity，就允许任务栈是可以获取焦点的，然后确保我们现在在更新相关的焦点栈。</p>

<p>(英文太烂，自己都不理解翻译出来的是什么👻 -_-! )</p>
</blockquote>

<p>根据上面两段注释，我们可以认为这里会调用mSupervisor.resumeFocusedStackTopActivityLocked(),这里的mSuperVisor对应的是ActivityStackSupervisor类。接着继续看下去：</p>

<p><img src="media/15486766374750/15486861634048.jpg" alt=""/>￼</p>

<p>我们在之前已经构造出一个ActivityRecord,所以这里会调用mFocusedStack.resumeTopActivityUncheckedLocked().其中mFocuseStack是ActivityStack的一个实例。<br/>
<img src="media/15486766374750/15486862880125.jpg" alt=""/>￼</p>

<p>在resumeTopActivityInnerLocked()中将调用<br/>
<img src="media/15486766374750/15486865513070.jpg" alt=""/>￼</p>

<p>这里又将调用过程交给了ActivityStackSupervisor。</p>

<p><img src="media/15486766374750/15486866052523.jpg" alt=""/>￼</p>

<p>这里将调用realStartActivityLocked()</p>

<p><img src="media/15486766374750/15486866431895.jpg" alt=""/>￼</p>

<p>realStartActivityLocked()又调用了app.thread.scheduleLaunchActivity()，这个app.thread就是客户端调用系统AMS时传递过来的ActivityThread对象，因此这里就是在调用客户端的ActivityThread.scheduleLaunchActivity()</p>

<blockquote>
<p>这里客户端指的就是当前的app进程，而服务端指的就是Android系统服务进程,可参看SystemServer类。之后也将会继续沿用客户端和服务端这样的概念。</p>
</blockquote>

<p><strong>小结二：</strong><br/>
<img src="media/15486766374750/15486879854107.jpg" alt=""/>￼</p>

<p><br/><br/>
前面一个小结结束之后，我们已经将调用过程从系统服务回调到了客户端，那么我们现在就接着看客户端做了哪些操作。</p>

<p>首先我们来看看ActivityThread.scheduleLaunchActivity()</p>

<p><img src="media/15486766374750/15487254546912.jpg" alt=""/>￼</p>

<p>这个方法中主要是将AMS传递过来的参数封装到ActivityClientRecord的实例中，并将这个ActivityClientRecord发送到消息队列，等待消息的处理。</p>

<p><img src="media/15486766374750/15487255560742.jpg" alt=""/>￼</p>

<p>查看sendMessage()方法，可以确定消息是通过mH来发送的，我们来看看mH的定义。<br/>
<img src="media/15486766374750/15487256540735.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15487256701988.jpg" alt=""/>￼</p>

<p>有定义内容可以知道mH就是一个Handler。<br/>
由上文我们知道ActivityThread.scheduleLaunchActivity()中发出的是一个LAUNCH_ACTIVITY消息，我们看看接收处的代码。</p>

<p><img src="media/15486766374750/15487257764437.jpg" alt=""/>￼</p>

<p>这里直接调用handleLaunchActivity() 来处理ActivityClientRecord ，继续查看这个方法<br/>
<img src="media/15486766374750/15487258434872.jpg" alt=""/>￼</p>

<p>在这个方法中，有两个明显的方法名称，一个performLaunchActivity()，一个是handleResumeActivity()。我们先来看看performLaunchActivity()，这个方法比较长，内容也比较多，我们细分几段来查看。</p>

<p>第一段：<br/>
<img src="media/15486766374750/15487261316606.jpg" alt=""/>￼</p>

<p>这里主要通过AMS传递过来的ActivityClientRecord进行包信息和ComponentName信息的构建。同时这个有个createBaseContextForActivity()<br/>
<img src="media/15486766374750/15487263361245.jpg" alt=""/>￼</p>

<p>在这个方法中将创建ContextImpl对象。<br/>
由此可到这一段主要是创建Activity上下文信息。</p>

<p>第二段：<br/>
<img src="media/15486766374750/15487264746227.jpg" alt=""/>￼</p>

<p>mInstrumentation.newActivity() 如下：<br/>
<img src="media/15486766374750/15487266082203.jpg" alt=""/>￼</p>

<p>这里通过反射创建了一个Activity实例。</p>

<p>第三段：</p>

<p><img src="media/15486766374750/15487267001597.jpg" alt=""/>￼</p>

<p>这里只是创建一个Applicatio的实例。<br/>
<img src="media/15486766374750/15487269199465.jpg" alt=""/>￼</p>

<p>代码1判断，application对象已经创建，则直接返回，这也是为什么同一个进程中，我们的application可以保持为一个单例的原因。<br/>
代码2则是创建了Application所需的上下文ContextImpl实例，同时调用Instrumentation.newApplication()创建了Application实例。<br/>
<img src="media/15486766374750/15487270600482.jpg" alt=""/>￼</p>

<p>这里我们可以看到，Application也是通过反射来创建的。创建完成之后立即调用了Application.attach(),attach()中将继续调用attachBaseContext()</p>

<p><img src="media/15486766374750/15487272158696.jpg" alt=""/>￼</p>

<p>回到入口方法makeApplication(),继续往下看。<br/>
<img src="media/15486766374750/15487273174539.jpg" alt=""/>￼</p>

<p>instrumentation.callApplicationOnCreate(app)</p>

<p><img src="media/15486766374750/15487273771032.jpg" alt=""/>￼</p>

<p>到这里，我们就将application的创建过程也看完了。所以第四段只是创建Application实例.</p>

<p>第四段</p>

<p><img src="media/15486766374750/15487275709948.jpg" alt=""/>￼</p>

<p>代码1就是调用了Activity.attach()。Activity.attach() 主要是创建Window信息。<br/>
代码2点进去，其实就在调用Activity.performCreate(),而performCreate()将调用onCreate()。<br/>
<img src="media/15486766374750/15487276231544.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15487277510425.jpg" alt=""/>￼</p>

<p><strong>小小结：</strong><br/>
第一段：创建Activity上下文</p>

<p>第二段：利用反射创建Activity</p>

<p>第三段：获取Application实例。如果已经存在则直接方法，如果未创建则利用反射创建Application实例，并调它的attach，onCreate等方法</p>

<p>第四段：调用Activity的attach和onCreate。值得一提的是attach() 中将创建window信息。</p>

<p>看到这里，我们基本已经明白了一个新Activity的创建过程，但是它是怎么作为一个界面显示出来的呢？这部分内容和WindowManagerService(简称WMS)相关，我们暂时先不讨论。以往我们常说，Activity在onResume之后才是可见的。那我们接下来就来找找这个说法的答案。</p>

<p>上文中的handleLaunchActivity(),除了performLaunchActivity(),我们还提到了handleResumeActivity(),接下来就点击去看看，这个方法又做了哪些操作。</p>

<p><img src="media/15486766374750/15487286148072.jpg" alt=""/>￼</p>

<p>handleResumeActivity() 调用了actiivty.performResume()<br/>
<img src="media/15486766374750/15487286377997.jpg" alt=""/>￼</p>

<p>在performResume()中，注意红框内容，这里分别调用了performRestart() 和mInstrumentation.callActivityOnResume() 分别对应的Activity.onStart()、Activity.reStart()和Activity.onResume().具体调用过程比较简单，这里就不再描述了。<br/>
<img src="media/15486766374750/15487289974956.jpg" alt=""/>￼</p>

<p>看到这里，我们也看完了activity.onResume的调用过程。但并没有找到到界面显示时机。我们回到handleResumeActivity()并继续往下看。</p>

<p><img src="media/15486766374750/15487296112064.jpg" alt=""/>￼</p>

<p>这里主要理解下注释：如果当前Activity的window未添加到WindowManager，这个activity就不可以关闭或打开新的activity。</p>

<p><img src="media/15486766374750/15487298313638.jpg" alt=""/>￼</p>

<p>这里先是将decor设置为不可见，然后将decor添加到WindowManager中。</p>

<p><img src="media/15486766374750/15487299092909.jpg" alt=""/>￼</p>

<p><img src="media/15486766374750/15487299393419.jpg" alt=""/>￼</p>

<p>这里又调用了一次mDecor.setVisibility(View.VISIBLE)将decorview设置为可见了。</p>

<p>看到这，我们也找到了Activity为什么是在onResume之后才是可见的。</p>

<p><strong>小结：</strong></p>

<ol>
<li><p>scheduleLaunchActivity()之后，通过Handler.sendMessage()将线程切换回主线程，同时在主线程中并调用handleLaunchActivity()。而handleLaunchActivity()方法中又将调用performLaunchActivity()和handleResumeActivity()。</p>

<p>这个小点即是scheduleLaunchActivity之后的调用过程，是比较简单的，这里就不再绘制时序图了。</p></li>
<li><p>performLaunchActivity() 主要分为四个片段<br/>
2.1 创建Activity上下文ContextImpl<br/>
2.2 利用反射创建Activity<br/>
2.3 获取Application实例。如果已经存在则直接返回，如果未创建则利用反射创建Application实例，并调它的attach，onCreate等方法<br/>
2.4 调用Activity的attach和onCreate。值得一提的是attach() 中将创建window信息。</p></li>
<li><p>handleResumeActivity <br/>
3.1 调用onstart，onReStart，onResume等方法<br/>
3.2 将decorview设置为不可见，然后将view添加到windowmanager<br/>
3.3 将decorview设置为可见</p></li>
</ol>

<p><br/><br/>
以上，一个Activity启动另一个Activity的过程，我们就算是看完了。这里主要将其分为三个步骤。</p>

<ol>
<li>客户端Activity通过Instrumentation获取AMS，并代用AMS的startActivity()</li>
<li>AMS中完成权限校验、Activity栈处理、目标Activity信息构建，然后通过ActivityThread.scheduleLaunchActivity回调到客户端</li>
<li>客户端通过handler将线程切换到主线程，然后在handleLaunchActivity() 中完成activity的创建和显示。</li>
</ol>

</div></body>

</html>
