<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Asher.zhang's blogs."><meta name="keywords" content="ç½‘ç«™å…³é”®å­—, Android, Ktolin, Java, Life"><title> | Zmy</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Zmy</h1><a id="logo" href="/.">Zmy</a><p class="description">Light dance and sunset</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta"><a href="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/#comments" class="comment-count"></a><p><span class="date">Jan 28, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>ç‚¹å‡»</i></i></span></p></div><div class="post-content"><h1 id="Activity-å¯åŠ¨è¿‡ç¨‹-ä¸€"><a href="#Activity-å¯åŠ¨è¿‡ç¨‹-ä¸€" class="headerlink" title="Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)"></a>Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)</h1><p>è¿™é‡Œè®²çš„æ˜¯ä¸€ä¸ªActivityå¯åŠ¨å¦ä¸€ä¸ªActivityçš„è¿‡ç¨‹ã€‚<br>é¦–å…ˆæˆ‘ä»¬åœ¨activity.startActivity(),ç‚¹è¿›å»æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486772761818.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486772908727.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486773071393.jpg" alt=""></p>
<p>åœ¨Activityä¸­æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨startActivityForResult(),åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆè°ƒç”¨mInstrumentation.execStartActivity()ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486776690721.jpg" alt=""></p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œè°ƒç”¨äº†ActivityManager.getService().startActivity(),æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹getService()ä¼šè¿”å›ä»€ä¹ˆå¯¹è±¡ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486778672837.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486778856899.jpg" alt=""></p>
<p>getService() åªæ˜¯è°ƒç”¨äº†IActivityManagerSingleton.get()ã€‚è€ŒIActivityManagerSingletonåˆ™æ˜¯ä¸€ä¸ªSingletonçš„å®ä¾‹ã€‚<br>Singletonçš„ä»£ç å¦‚ä¸‹ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486779802660.jpg" alt=""></p>
<p>ä»Singletonå¯ä»¥çœ‹åˆ°ï¼ŒIActivityManagerSingleton.get()åœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™ä¼šè°ƒç”¨create()ï¼Œè€Œè¿™ä¸ªIActivityManagerSingleton çš„create() æ­£æ˜¯çš„å‰é¢çœ‹åˆ°çš„è¿™ä¸ªæ–¹æ³•ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486778856899.jpg" alt=""></p>
<p>è¿™é‡Œå°†é€šè¿‡IActivityManager.Stub.asInterface(b)è¿”å›ä¸€ä¸ªIActivityManagerå¯¹è±¡å®ä¾‹ã€‚å› æ­¤IActivityManagerSingleton.get()ä¹Ÿå°†è¿”å›ä¸€ä¸ªIActivityManagerå¯¹è±¡å®ä¾‹ã€‚</p>
<p>å› ä¸ºç¬”è€…è¿™é‡Œçœ‹çš„æ˜¯26çš„æºç ï¼Œ26ä¸­å¢åŠ äº†IActivityManager.aidlæ–‡ä»¶ï¼Œè¿™éƒ¨åˆ†ä»£ç éœ€è¦åœ¨<a href="http://androidxref.com/8.0.0_r4/xref/frameworks/base/core/java/android/app/IActivityManager.aidl" target="_blank" rel="noopener">AndroidXrefä¸­çš„IActivityManager.aidl</a>ä¸­æŸ¥çœ‹ï¼Œéƒ¨åˆ†å®šä¹‰å¦‚ä¸‹ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486787413207.jpg" alt=""></p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨aidlçš„æ—¶å€™ï¼ŒASéƒ½ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªStubå’Œæœ¬åœ°çš„ä»£ç†å¯¹è±¡ã€‚IActivityManagerä¹Ÿä¼šå¯¹åº”ç”Ÿæˆä¸€ä¸ªIActivityManager.Stubç±»ï¼Œä¸”å®ƒæœ‰ä¸ªå­ç±»ä¸ºActivityManagerService<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486794120831.jpg" alt=""></p>
<p>è€Œæˆ‘ä»¬ä¹‹å‰IActivityManagerSingleton.get()å–å¾—çš„å°±æ˜¯ä¸€ä¸ªActivityManagerServiceæˆ–è€…æ˜¯ActivityManagerServiceçš„ä¸€ä¸ªä»£ç†ã€‚</p>
<blockquote>
<p>æ³¨ï¼šè¿™ä¸€éƒ¨åˆ†å…·ä½“å‚è€ƒä¸‹Binderçš„å®šä¹‰åŠä½¿ç”¨ã€‚å¦å¤–æˆ‘è¿˜æ²¡æœ‰è¯´æ˜å¦‚ä½•èƒ½æ‰¾åˆ°ActivityManagerServiceï¼Œè¿™ä¸€éƒ¨åˆ†éƒ½æ˜¯å‚è€ƒå…¶ä»–æ–‡ç« æ‰€å¾—ï¼Œå…·ä½“å¦‚ä½•é€šè¿‡IActivityManager.aidlå®šä½åˆ°è¿™ä¸ªç±»çš„ï¼Œè¿˜éœ€è¦å†æ‹ä¸€æ‹ã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å›åˆ°Instrumentation<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486797142078.jpg" alt=""></p>
<p>ActivityManager.getService() å³è¿”å›ä¸€ä¸ªActivityManagerServiceæˆ–è€…å…¶ä»£ç†å¯¹è±¡ã€‚æ‰€ä»¥è¿™é‡Œæœ€ç»ˆå°±æ˜¯è°ƒç”¨äº†ActivityManagerService.startActivity()<br><br><br><strong>å°ç»“ä¸€ï¼š</strong><br>è¿™é‡Œä½¿ç”¨ç®€å•çš„æ—¶åºå›¾æ¥è¯´æ˜æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ã€‚è¿™é‡Œçš„AMSå³æ—¶ActivityManagerServiceçš„ç¼©å†™ï¼Œä¹‹åè¯»å°†é‡‡ç”¨è¿™ä¸ªç¼©å†™æ¥ä»£ç ActivityManagerService.</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486811350826.jpg" alt=""></p>
<p><br><br><br><br>æˆ‘ä»¬é€šè¿‡å‰é¢æ–¹æ³•çš„æŸ¥æ‰¾ï¼Œå·²ç»çŸ¥é“å¯åŠ¨ä¸€ä¸ªActivityä¹‹åï¼Œæœ€ç»ˆä¼šè°ƒç”¨ç³»ç»Ÿçš„ActivityManagerService.startActivity(),æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åˆåšäº†å“ªäº›æ“ä½œã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486816418828.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486816757171.jpg" alt=""></p>
<p>è¿™é‡Œæœ€åè°ƒç”¨äº†mActivityStarter.startActivityMayWait(),è¿™æ ·å°±å°†è°ƒç”¨è¿‡ç¨‹è½¬äº¤ç»™äº†ActivityStarterç±»ã€‚</p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™ä¸€å¥è¯ï¼Œè¿™ä¸»è¦æ˜¯åœ¨æ”¶é›†ç›®æ ‡Activityçš„ä¿¡æ¯ï¼Œå°†ä¿¡æ¯å­˜å‚¨åœ¨ActivityInfoä¸­ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486819210213.jpg" alt=""></p>
<p>ä¹‹ååˆè°ƒç”¨äº†æœ¬ç±»ä¸­çš„startActivityLocked()ï¼Œå¦‚ä¸‹ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486819855403.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486820892862.jpg" alt=""></p>
<p>åœ¨è¿™é‡Œæ ¡éªŒäº†è°ƒç”¨æ–¹æ³•çš„åŸå› ã€‚ç„¶åè°ƒç”¨äº†ActivityStarterä¸­çš„startActivity()ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486822330110.jpg" alt=""></p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦åšäº†ä¸€äº›æ ¡éªŒï¼ŒåŒ…æ‹¬ï¼šæƒé™æ ¡éªŒã€componentæ ¡éªŒã€ç›®æ ‡activityä¿¡æ¯æ ¡éªŒç­‰ã€‚åŒæ—¶åˆ›å»ºä¸€ä¸ªActivityRecordå¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾è¿™äº›æ ¡éªŒè¿‡åçš„æ•°æ®ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486827320180.jpg" alt=""></p>
<p>ç„¶åç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªstartActivity()<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486827457382.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486827875618.jpg" alt=""></p>
<p>åœ¨è¿™ä¸ªstartActivity()ä¸­å°†è°ƒç”¨ActivityStarterçš„startActivityUnchecked()ï¼ŒstartActivityUnchecked()æ–¹æ³•æŒºé•¿ï¼Œä¸»è¦æ˜¯activityæ ˆçš„å¤„ç†ï¼Œæ¯”å¦‚æ˜¯å¦åœ¨æ ˆé¡¶ã€æ˜¯å¦éœ€è¦æ–°å»ºä¸€ä¸ªæ ˆã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†è°ƒç”¨mSupervisor.resumeFocusedStackTopActivityLocked().</p>
<p>è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ<br>é¦–å…ˆæˆ‘ä»¬å›åˆ°è¿™é‡Œ<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486827457382.jpg" alt=""></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬å…­ä¸ªå‚æ•°è®¾ç½®ä¸ºtrueï¼Œè€Œè¿™ä¸ªtrueå°†ä¸€ç›´è·Ÿç€æˆ‘ä»¬çš„æ–¹æ³•ä¼ é€’ä¸‹å»ï¼Œç›´åˆ°startActivityUncheckedè°ƒç”¨äº†setInitialState()ä¹‹åå°†è¿™ä¸ªtrueèµ‹ç»™äº†ActivityStarterä¸­çš„mDoResumeå±æ€§ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486841490088.jpg" alt=""><br>å› æ­¤ï¼Œæœ€åæˆ‘ä»¬å°†èµ°å…¥è¿™ä¸ªä»£ç å—ã€‚<br>è¿™é‡Œä¸¤æ®µè‹±æ–‡ï¼Œå°è¯•ç€ç¿»è¯‘ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>If the activity is not focusable, we canâ€™t resume it, but still would like to make sure it becomes visible as it starts (this will also trigger entry animation). An example of this are PIP activities.Also, we donâ€™t want to resume activities in a task that currently has an overlay as the starting activity just needs to be in the visible paused state until the over is removed.<br>å¦‚æœActivityä¸å¯èšç„¦ï¼Œå°±ä¸èƒ½é‡å¯å®ƒï¼Œä¸è¿‡æˆ‘ä»¬ä»å¯ä¿è¯å½“å®ƒå¯åŠ¨çš„æ—¶å€™æ˜¯å¯è§çš„ã€‚æ¯”å¦‚PIPçš„æ´»åŠ¨ã€‚æˆ‘ä»¬ä¸æƒ³é‡å¯ä¸€ä¸ªå¯è¦†ç›–ä»»åŠ¡ä¸­çš„activitiesï¼Œå› ä¸ºå¼€å§‹çš„æ´»åŠ¨åªéœ€è¦å¤„äºå¯è§çš„æš‚åœçŠ¶æ€ï¼Œç›´åˆ°ç§»é™¤è¦†ç›–ã€‚</p>
<p>If the target stack was not previously focusable (previous top running activity on that stack was not visible) then any prior calls to move the stack to the will not update the focused stack.  If starting the new activity now allows the task stack to be focusable, then ensure that we now update the focused stack accordingly.<br>å¦‚æœç›®æ ‡æ ˆä¹‹å‰ä¸å¯è·å–ç„¦ç‚¹ï¼ˆä¹‹å‰é¡¶å±‚çš„activityä¸å¯è§ï¼‰ï¼Œé‚£ä¹ˆå°†è¯¥æ ˆç§»åŠ¨åˆ°ä¸ä¼šæ›´æ–°çš„ç„¦ç‚¹æ ˆä¸­ã€‚å¦‚æœç°åœ¨æ˜¯æ–°å»ºä¸€ä¸ªactivityï¼Œå°±å…è®¸ä»»åŠ¡æ ˆæ˜¯å¯ä»¥è·å–ç„¦ç‚¹çš„ï¼Œç„¶åç¡®ä¿æˆ‘ä»¬ç°åœ¨åœ¨æ›´æ–°ç›¸å…³çš„ç„¦ç‚¹æ ˆã€‚</p>
<p>(è‹±æ–‡å¤ªçƒ‚ï¼Œè‡ªå·±éƒ½ä¸ç†è§£ç¿»è¯‘å‡ºæ¥çš„æ˜¯ä»€ä¹ˆğŸ‘» -_-! )</p>
</blockquote>
<p>æ ¹æ®ä¸Šé¢ä¸¤æ®µæ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™é‡Œä¼šè°ƒç”¨mSupervisor.resumeFocusedStackTopActivityLocked(),è¿™é‡Œçš„mSuperVisorå¯¹åº”çš„æ˜¯ActivityStackSupervisorç±»ã€‚æ¥ç€ç»§ç»­çœ‹ä¸‹å»ï¼š</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486861634048.jpg" alt=""></p>
<p>æˆ‘ä»¬åœ¨ä¹‹å‰å·²ç»æ„é€ å‡ºä¸€ä¸ªActivityRecord,æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨mFocusedStack.resumeTopActivityUncheckedLocked().å…¶ä¸­mFocuseStackæ˜¯ActivityStackçš„ä¸€ä¸ªå®ä¾‹ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486862880125.jpg" alt=""></p>
<p>åœ¨resumeTopActivityInnerLocked()ä¸­å°†è°ƒç”¨<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486865513070.jpg" alt=""></p>
<p>è¿™é‡Œåˆå°†è°ƒç”¨è¿‡ç¨‹äº¤ç»™äº†ActivityStackSupervisorã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486866052523.jpg" alt=""></p>
<p>è¿™é‡Œå°†è°ƒç”¨realStartActivityLocked()</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486866431895.jpg" alt=""></p>
<p>realStartActivityLocked()åˆè°ƒç”¨äº†app.thread.scheduleLaunchActivity()ï¼Œè¿™ä¸ªapp.threadå°±æ˜¯å®¢æˆ·ç«¯è°ƒç”¨ç³»ç»ŸAMSæ—¶ä¼ é€’è¿‡æ¥çš„ActivityThreadå¯¹è±¡ï¼Œå› æ­¤è¿™é‡Œå°±æ˜¯åœ¨è°ƒç”¨å®¢æˆ·ç«¯çš„ActivityThread.scheduleLaunchActivity()</p>
<blockquote>
<p>è¿™é‡Œå®¢æˆ·ç«¯æŒ‡çš„å°±æ˜¯å½“å‰çš„appè¿›ç¨‹ï¼Œè€ŒæœåŠ¡ç«¯æŒ‡çš„å°±æ˜¯Androidç³»ç»ŸæœåŠ¡è¿›ç¨‹,å¯å‚çœ‹SystemServerç±»ã€‚ä¹‹åä¹Ÿå°†ä¼šç»§ç»­æ²¿ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿™æ ·çš„æ¦‚å¿µã€‚</p>
</blockquote>
<p><strong>å°ç»“äºŒï¼š</strong><br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15486879854107.jpg" alt=""></p>
<p><br><br>å‰é¢ä¸€ä¸ªå°ç»“ç»“æŸä¹‹åï¼Œæˆ‘ä»¬å·²ç»å°†è°ƒç”¨è¿‡ç¨‹ä»ç³»ç»ŸæœåŠ¡å›è°ƒåˆ°äº†å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±æ¥ç€çœ‹å®¢æˆ·ç«¯åšäº†å“ªäº›æ“ä½œã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ActivityThread.scheduleLaunchActivity()</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487254546912.jpg" alt=""></p>
<p>è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦æ˜¯å°†AMSä¼ é€’è¿‡æ¥çš„å‚æ•°å°è£…åˆ°ActivityClientRecordçš„å®ä¾‹ä¸­ï¼Œå¹¶å°†è¿™ä¸ªActivityClientRecordå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…æ¶ˆæ¯çš„å¤„ç†ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487255560742.jpg" alt=""></p>
<p>æŸ¥çœ‹sendMessage()æ–¹æ³•ï¼Œå¯ä»¥ç¡®å®šæ¶ˆæ¯æ˜¯é€šè¿‡mHæ¥å‘é€çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹mHçš„å®šä¹‰ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487256540735.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487256701988.jpg" alt=""></p>
<p>æœ‰å®šä¹‰å†…å®¹å¯ä»¥çŸ¥é“mHå°±æ˜¯ä¸€ä¸ªHandlerã€‚<br>ç”±ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ActivityThread.scheduleLaunchActivity()ä¸­å‘å‡ºçš„æ˜¯ä¸€ä¸ªLAUNCH_ACTIVITYæ¶ˆæ¯ï¼Œæˆ‘ä»¬çœ‹çœ‹æ¥æ”¶å¤„çš„ä»£ç ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487257764437.jpg" alt=""></p>
<p>è¿™é‡Œç›´æ¥è°ƒç”¨handleLaunchActivity() æ¥å¤„ç†ActivityClientRecord ï¼Œç»§ç»­æŸ¥çœ‹è¿™ä¸ªæ–¹æ³•<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487258434872.jpg" alt=""></p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ˜æ˜¾çš„æ–¹æ³•åç§°ï¼Œä¸€ä¸ªperformLaunchActivity()ï¼Œä¸€ä¸ªæ˜¯handleResumeActivity()ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹performLaunchActivity()ï¼Œè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œå†…å®¹ä¹Ÿæ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ç»†åˆ†å‡ æ®µæ¥æŸ¥çœ‹ã€‚</p>
<p>ç¬¬ä¸€æ®µï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487261316606.jpg" alt=""></p>
<p>è¿™é‡Œä¸»è¦é€šè¿‡AMSä¼ é€’è¿‡æ¥çš„ActivityClientRecordè¿›è¡ŒåŒ…ä¿¡æ¯å’ŒComponentNameä¿¡æ¯çš„æ„å»ºã€‚åŒæ—¶è¿™ä¸ªæœ‰ä¸ªcreateBaseContextForActivity()<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487263361245.jpg" alt=""></p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†åˆ›å»ºContextImplå¯¹è±¡ã€‚<br>ç”±æ­¤å¯åˆ°è¿™ä¸€æ®µä¸»è¦æ˜¯åˆ›å»ºActivityä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>ç¬¬äºŒæ®µï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487264746227.jpg" alt=""></p>
<p>mInstrumentation.newActivity() å¦‚ä¸‹ï¼š<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487266082203.jpg" alt=""></p>
<p>è¿™é‡Œé€šè¿‡åå°„åˆ›å»ºäº†ä¸€ä¸ªActivityå®ä¾‹ã€‚</p>
<p>ç¬¬ä¸‰æ®µï¼š</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487267001597.jpg" alt=""></p>
<p>è¿™é‡Œåªæ˜¯åˆ›å»ºä¸€ä¸ªApplicatioçš„å®ä¾‹ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487269199465.jpg" alt=""></p>
<p>ä»£ç 1åˆ¤æ–­ï¼Œapplicationå¯¹è±¡å·²ç»åˆ›å»ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„applicationå¯ä»¥ä¿æŒä¸ºä¸€ä¸ªå•ä¾‹çš„åŸå› ã€‚<br>ä»£ç 2åˆ™æ˜¯åˆ›å»ºäº†Applicationæ‰€éœ€çš„ä¸Šä¸‹æ–‡ContextImplå®ä¾‹ï¼ŒåŒæ—¶è°ƒç”¨Instrumentation.newApplication()åˆ›å»ºäº†Applicationå®ä¾‹ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487270600482.jpg" alt=""></p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒApplicationä¹Ÿæ˜¯é€šè¿‡åå°„æ¥åˆ›å»ºçš„ã€‚åˆ›å»ºå®Œæˆä¹‹åç«‹å³è°ƒç”¨äº†Application.attach(),attach()ä¸­å°†ç»§ç»­è°ƒç”¨attachBaseContext()</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487272158696.jpg" alt=""></p>
<p>å›åˆ°å…¥å£æ–¹æ³•makeApplication(),ç»§ç»­å¾€ä¸‹çœ‹ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487273174539.jpg" alt=""></p>
<p>instrumentation.callApplicationOnCreate(app)</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487273771032.jpg" alt=""></p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å°†applicationçš„åˆ›å»ºè¿‡ç¨‹ä¹Ÿçœ‹å®Œäº†ã€‚æ‰€ä»¥ç¬¬å››æ®µåªæ˜¯åˆ›å»ºApplicationå®ä¾‹.</p>
<p>ç¬¬å››æ®µ</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487275709948.jpg" alt=""></p>
<p>ä»£ç 1å°±æ˜¯è°ƒç”¨äº†Activity.attach()ã€‚Activity.attach() ä¸»è¦æ˜¯åˆ›å»ºWindowä¿¡æ¯ã€‚<br>ä»£ç 2ç‚¹è¿›å»ï¼Œå…¶å®å°±åœ¨è°ƒç”¨Activity.performCreate(),è€ŒperformCreate()å°†è°ƒç”¨onCreate()ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487276231544.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487277510425.jpg" alt=""></p>
<p><strong>å°å°ç»“ï¼š</strong><br>ç¬¬ä¸€æ®µï¼šåˆ›å»ºActivityä¸Šä¸‹æ–‡</p>
<p>ç¬¬äºŒæ®µï¼šåˆ©ç”¨åå°„åˆ›å»ºActivity</p>
<p>ç¬¬ä¸‰æ®µï¼šè·å–Applicationå®ä¾‹ã€‚å¦‚æœå·²ç»å­˜åœ¨åˆ™ç›´æ¥æ–¹æ³•ï¼Œå¦‚æœæœªåˆ›å»ºåˆ™åˆ©ç”¨åå°„åˆ›å»ºApplicationå®ä¾‹ï¼Œå¹¶è°ƒå®ƒçš„attachï¼ŒonCreateç­‰æ–¹æ³•</p>
<p>ç¬¬å››æ®µï¼šè°ƒç”¨Activityçš„attachå’ŒonCreateã€‚å€¼å¾—ä¸€æçš„æ˜¯attach() ä¸­å°†åˆ›å»ºwindowä¿¡æ¯ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åŸºæœ¬å·²ç»æ˜ç™½äº†ä¸€ä¸ªæ–°Activityçš„åˆ›å»ºè¿‡ç¨‹ï¼Œä½†æ˜¯å®ƒæ˜¯æ€ä¹ˆä½œä¸ºä¸€ä¸ªç•Œé¢æ˜¾ç¤ºå‡ºæ¥çš„å‘¢ï¼Ÿè¿™éƒ¨åˆ†å†…å®¹å’ŒWindowManagerService(ç®€ç§°WMS)ç›¸å…³ï¼Œæˆ‘ä»¬æš‚æ—¶å…ˆä¸è®¨è®ºã€‚ä»¥å¾€æˆ‘ä»¬å¸¸è¯´ï¼ŒActivityåœ¨onResumeä¹‹åæ‰æ˜¯å¯è§çš„ã€‚é‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ¥æ‰¾æ‰¾è¿™ä¸ªè¯´æ³•çš„ç­”æ¡ˆã€‚</p>
<p>ä¸Šæ–‡ä¸­çš„handleLaunchActivity(),é™¤äº†performLaunchActivity(),æˆ‘ä»¬è¿˜æåˆ°äº†handleResumeActivity(),æ¥ä¸‹æ¥å°±ç‚¹å‡»å»çœ‹çœ‹ï¼Œè¿™ä¸ªæ–¹æ³•åˆåšäº†å“ªäº›æ“ä½œã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487286148072.jpg" alt=""></p>
<p>handleResumeActivity() è°ƒç”¨äº†actiivty.performResume()<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487286377997.jpg" alt=""></p>
<p>åœ¨performResume()ä¸­ï¼Œæ³¨æ„çº¢æ¡†å†…å®¹ï¼Œè¿™é‡Œåˆ†åˆ«è°ƒç”¨äº†performRestart() å’ŒmInstrumentation.callActivityOnResume() åˆ†åˆ«å¯¹åº”çš„Activity.onStart()ã€Activity.reStart()å’ŒActivity.onResume().å…·ä½“è°ƒç”¨è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å†æè¿°äº†ã€‚<br><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487289974956.jpg" alt=""></p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿçœ‹å®Œäº†activity.onResumeçš„è°ƒç”¨è¿‡ç¨‹ã€‚ä½†å¹¶æ²¡æœ‰æ‰¾åˆ°åˆ°ç•Œé¢æ˜¾ç¤ºæ—¶æœºã€‚æˆ‘ä»¬å›åˆ°handleResumeActivity()å¹¶ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487296112064.jpg" alt=""></p>
<p>è¿™é‡Œä¸»è¦ç†è§£ä¸‹æ³¨é‡Šï¼šå¦‚æœå½“å‰Activityçš„windowæœªæ·»åŠ åˆ°WindowManagerï¼Œè¿™ä¸ªactivityå°±ä¸å¯ä»¥å…³é—­æˆ–æ‰“å¼€æ–°çš„activityã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487298313638.jpg" alt=""></p>
<p>è¿™é‡Œå…ˆæ˜¯å°†decorè®¾ç½®ä¸ºä¸å¯è§ï¼Œç„¶åå°†decoræ·»åŠ åˆ°WindowManagerä¸­ã€‚</p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487299092909.jpg" alt=""></p>
<p><img src="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/media/15486766374750/15487299393419.jpg" alt=""></p>
<p>è¿™é‡Œåˆè°ƒç”¨äº†ä¸€æ¬¡mDecor.setVisibility(View.VISIBLE)å°†decorviewè®¾ç½®ä¸ºå¯è§äº†ã€‚</p>
<p>çœ‹åˆ°è¿™ï¼Œæˆ‘ä»¬ä¹Ÿæ‰¾åˆ°äº†Activityä¸ºä»€ä¹ˆæ˜¯åœ¨onResumeä¹‹åæ‰æ˜¯å¯è§çš„ã€‚</p>
<p><strong>å°ç»“ï¼š</strong></p>
<ol>
<li><p>scheduleLaunchActivity()ä¹‹åï¼Œé€šè¿‡Handler.sendMessage()å°†çº¿ç¨‹åˆ‡æ¢å›ä¸»çº¿ç¨‹ï¼ŒåŒæ—¶åœ¨ä¸»çº¿ç¨‹ä¸­å¹¶è°ƒç”¨handleLaunchActivity()ã€‚è€ŒhandleLaunchActivity()æ–¹æ³•ä¸­åˆå°†è°ƒç”¨performLaunchActivity()å’ŒhandleResumeActivity()ã€‚</p>
<p> è¿™ä¸ªå°ç‚¹å³æ˜¯scheduleLaunchActivityä¹‹åçš„è°ƒç”¨è¿‡ç¨‹ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸å†ç»˜åˆ¶æ—¶åºå›¾äº†ã€‚</p>
</li>
<li><p>performLaunchActivity() ä¸»è¦åˆ†ä¸ºå››ä¸ªç‰‡æ®µ<br>2.1 åˆ›å»ºActivityä¸Šä¸‹æ–‡ContextImpl<br>2.2 åˆ©ç”¨åå°„åˆ›å»ºActivity<br>2.3 è·å–Applicationå®ä¾‹ã€‚å¦‚æœå·²ç»å­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœæœªåˆ›å»ºåˆ™åˆ©ç”¨åå°„åˆ›å»ºApplicationå®ä¾‹ï¼Œå¹¶è°ƒå®ƒçš„attachï¼ŒonCreateç­‰æ–¹æ³•<br>2.4 è°ƒç”¨Activityçš„attachå’ŒonCreateã€‚å€¼å¾—ä¸€æçš„æ˜¯attach() ä¸­å°†åˆ›å»ºwindowä¿¡æ¯ã€‚</p>
</li>
<li><p>handleResumeActivity<br>3.1 è°ƒç”¨onstartï¼ŒonReStartï¼ŒonResumeç­‰æ–¹æ³•<br>3.2 å°†decorviewè®¾ç½®ä¸ºä¸å¯è§ï¼Œç„¶åå°†viewæ·»åŠ åˆ°windowmanager<br>3.3 å°†decorviewè®¾ç½®ä¸ºå¯è§</p>
</li>
</ol>
<p><br><br>ä»¥ä¸Šï¼Œä¸€ä¸ªActivityå¯åŠ¨å¦ä¸€ä¸ªActivityçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±ç®—æ˜¯çœ‹å®Œäº†ã€‚è¿™é‡Œä¸»è¦å°†å…¶åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<ol>
<li>å®¢æˆ·ç«¯Activityé€šè¿‡Instrumentationè·å–AMSï¼Œå¹¶ä»£ç”¨AMSçš„startActivity()</li>
<li>AMSä¸­å®Œæˆæƒé™æ ¡éªŒã€Activityæ ˆå¤„ç†ã€ç›®æ ‡Activityä¿¡æ¯æ„å»ºï¼Œç„¶åé€šè¿‡ActivityThread.scheduleLaunchActivityå›è°ƒåˆ°å®¢æˆ·ç«¯</li>
<li>å®¢æˆ·ç«¯é€šè¿‡handlerå°†çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œç„¶ååœ¨handleLaunchActivity() ä¸­å®Œæˆactivityçš„åˆ›å»ºå’Œæ˜¾ç¤ºã€‚</li>
</ol>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">åˆ†äº«åˆ°ï¼š</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="åˆ†äº«åˆ°ä¸€é”®åˆ†äº«" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="åˆ†äº«åˆ°Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="åˆ†äº«åˆ°Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="åˆ†äº«åˆ°linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="åˆ†äº«åˆ°æœ‰é“äº‘ç¬”è®°" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="åˆ†äº«åˆ°å°è±¡ç¬”è®°" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="åˆ†äº«åˆ°å¾®ä¿¡" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="åˆ†äº«åˆ°QQç©ºé—´" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2019/01/29/Activityå¯åŠ¨è¿‡ç¨‹(äºŒ)/" class="pre"></a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">æ–‡ç« ç›®å½•</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Activity-å¯åŠ¨è¿‡ç¨‹-ä¸€"><span class="toc-text">Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> æœ€æ–°æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/Activityå¯åŠ¨è¿‡ç¨‹(äºŒ)/">Activityå¯åŠ¨è¿‡ç¨‹(äºŒ)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)/">Activity å¯åŠ¨è¿‡ç¨‹(ä¸€)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> æ ‡ç­¾</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> å½’æ¡£</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">ä¸€æœˆ 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site HaritasÄ±</a> |  <a href="/atom.xml">è®¢é˜…</a> |  <a href="/about/">å…³äº</a></p><p>æœ¬ç«™æ€»è®¿é—®é‡ï¼š<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>æ¬¡</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Asher.zhang.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"åˆ†äº«åˆ°ï¼š","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>